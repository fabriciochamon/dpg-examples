import dearpygui.dearpygui as dpg
import dearpygui_extend as dpge
import os

# uses a .pref file to persist last selected folder
DEFAULT_PATH = os.path.expanduser('~')
if os.path.isfile('./.pref'):
	with open('./.pref', 'r') as f:
		contents = f.read()
		if os.path.isdir(contents):
			DEFAULT_PATH = contents

dpg.create_context()
dpg.create_viewport(title='Batch renamer', width=850, height=800)

# icons
icon_file       = [0, 0, 0, 0, 0, 0, 0, 0, 153, 153, 153, 35, 160, 160, 160, 89, 160, 160, 160, 89, 160, 160, 160, 89, 160, 160, 160, 89, 160, 160, 160, 89, 160, 160, 160, 89, 163, 163, 163, 72, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 141, 141, 141, 143, 212, 212, 212, 255, 213, 213, 213, 255, 213, 213, 213, 255, 213, 213, 213, 255, 213, 213, 213, 255, 213, 213, 213, 255, 192, 192, 192, 255, 153, 153, 153, 195, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 143, 143, 143, 143, 214, 214, 214, 255, 215, 215, 215, 255, 215, 215, 215, 255, 215, 215, 215, 255, 215, 215, 215, 255, 215, 215, 215, 255, 204, 204, 204, 255, 194, 194, 194, 255, 149, 149, 149, 204, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 143, 143, 143, 143, 216, 216, 216, 255, 216, 216, 216, 255, 217, 217, 217, 255, 217, 217, 217, 255, 217, 217, 217, 255, 217, 217, 217, 255, 209, 209, 209, 255, 169, 169, 169, 255, 190, 190, 190, 255, 144, 144, 144, 186, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 144, 144, 144, 143, 218, 218, 218, 255, 218, 218, 218, 255, 219, 219, 219, 255, 219, 219, 219, 255, 219, 219, 219, 255, 218, 218, 218, 255, 215, 215, 215, 255, 189, 189, 189, 255, 190, 190, 190, 255, 198, 198, 198, 254, 142, 142, 142, 95, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 146, 146, 146, 143, 219, 219, 219, 255, 220, 220, 220, 255, 220, 220, 220, 255, 221, 221, 221, 255, 221, 221, 221, 255, 220, 220, 220, 255, 220, 220, 220, 255, 219, 219, 219, 255, 219, 219, 219, 255, 218, 218, 218, 255, 144, 144, 144, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 146, 146, 146, 143, 221, 221, 221, 255, 222, 222, 222, 255, 222, 222, 222, 255, 222, 222, 222, 255, 222, 222, 222, 255, 222, 222, 222, 255, 222, 222, 222, 255, 221, 221, 221, 255, 220, 220, 220, 255, 219, 219, 219, 255, 144, 144, 144, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 148, 148, 143, 223, 223, 223, 255, 223, 223, 223, 255, 224, 224, 224, 255, 224, 224, 224, 255, 224, 224, 224, 255, 224, 224, 224, 255, 224, 224, 224, 255, 223, 223, 223, 255, 222, 222, 222, 255, 221, 221, 221, 255, 145, 145, 145, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 148, 148, 143, 224, 224, 224, 255, 225, 225, 225, 255, 226, 226, 226, 255, 226, 226, 226, 255, 226, 226, 226, 255, 226, 226, 226, 255, 225, 225, 225, 255, 225, 225, 225, 255, 224, 224, 224, 255, 223, 223, 223, 255, 145, 145, 145, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 148, 148, 148, 143, 225, 225, 225, 255, 226, 226, 226, 255, 227, 227, 227, 255, 228, 228, 228, 255, 228, 228, 228, 255, 228, 228, 228, 255, 227, 227, 227, 255, 226, 226, 226, 255, 225, 225, 225, 255, 224, 224, 224, 255, 147, 147, 147, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 150, 150, 150, 143, 227, 227, 227, 255, 228, 228, 228, 255, 229, 229, 229, 255, 229, 229, 229, 255, 230, 230, 230, 255, 230, 230, 230, 255, 229, 229, 229, 255, 228, 228, 228, 255, 227, 227, 227, 255, 225, 225, 225, 255, 149, 149, 149, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 150, 150, 150, 143, 228, 228, 228, 255, 229, 229, 229, 255, 230, 230, 230, 255, 231, 231, 231, 255, 232, 232, 232, 255, 231, 231, 231, 255, 231, 231, 231, 255, 230, 230, 230, 255, 228, 228, 228, 255, 227, 227, 227, 255, 149, 149, 149, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 152, 152, 152, 143, 229, 229, 229, 255, 230, 230, 230, 255, 232, 232, 232, 255, 233, 233, 233, 255, 233, 233, 233, 255, 233, 233, 233, 255, 232, 232, 232, 255, 231, 231, 231, 255, 230, 230, 230, 255, 228, 228, 228, 255, 149, 149, 149, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 152, 152, 152, 143, 229, 229, 229, 255, 231, 231, 231, 255, 233, 233, 233, 255, 234, 234, 234, 255, 235, 235, 235, 255, 235, 235, 235, 255, 234, 234, 234, 255, 232, 232, 232, 255, 231, 231, 231, 255, 229, 229, 229, 255, 151, 151, 151, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 152, 152, 152, 143, 230, 230, 230, 255, 231, 231, 231, 255, 233, 233, 233, 255, 235, 235, 235, 255, 237, 237, 237, 255, 237, 237, 237, 255, 235, 235, 235, 255, 233, 233, 233, 255, 231, 231, 231, 255, 229, 229, 229, 255, 151, 151, 151, 142, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 28, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0]
icon_file       = [float(x)/255 for x in icon_file]
icon_folder     = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 177, 159, 87, 17, 236, 213, 118, 129, 236, 213, 118, 129, 236, 213, 118, 129, 234, 211, 117, 118, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 214, 193, 109, 64, 219, 198, 116, 156, 248, 224, 128, 255, 248, 224, 128, 255, 248, 224, 128, 255, 245, 221, 126, 250, 216, 195, 114, 137, 215, 195, 114, 138, 215, 195, 114, 138, 216, 195, 114, 137, 217, 196, 116, 136, 218, 197, 116, 136, 219, 198, 117, 135, 223, 202, 118, 134, 0, 0, 0, 0, 0, 0, 0, 0, 206, 194, 154, 134, 243, 241, 236, 255, 235, 233, 228, 255, 228, 226, 219, 255, 226, 224, 219, 255, 225, 223, 218, 255, 223, 221, 217, 255, 223, 221, 218, 255, 223, 222, 218, 255, 224, 222, 219, 255, 227, 226, 222, 255, 229, 227, 224, 255, 230, 229, 225, 255, 229, 225, 213, 255, 0, 0, 0, 9, 0, 0, 0, 4, 204, 193, 160, 135, 252, 252, 252, 255, 248, 224, 133, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 254, 229, 127, 253, 219, 197, 109, 63, 203, 193, 160, 135, 252, 252, 251, 255, 255, 230, 127, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 250, 226, 125, 231, 188, 169, 93, 25, 203, 193, 160, 135, 251, 250, 250, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 244, 220, 122, 193, 0, 0, 0, 3, 203, 193, 160, 135, 240, 239, 238, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 234, 211, 117, 136, 0, 0, 0, 0, 204, 193, 160, 135, 232, 226, 208, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 216, 195, 108, 75, 0, 0, 0, 0, 184, 171, 126, 135, 243, 222, 138, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 139, 125, 67, 4, 0, 0, 0, 0, 190, 171, 96, 136, 253, 228, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 255, 230, 128, 255, 0, 0, 0, 0, 0, 0, 0, 0, 196, 176, 97, 75, 220, 198, 110, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 219, 197, 109, 154, 221, 199, 110, 152, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
icon_folder     = [float(x)/255 for x in icon_folder]

with dpg.texture_registry():
	dpg.add_static_texture(tag='icon_file', width=16, height=16, default_value=icon_file)
	dpg.add_static_texture(tag='icon_folder', width=16, height=16, default_value=icon_folder)


def table_click(sender, app_data, user_data):
	dpg.set_value('find', user_data)
	dpg.set_value('replace', user_data)
	rebuild_child_win()

def replace():
	folder = dpg.get_value('folder')
	files = sorted(os.listdir(folder))
	str_from = dpg.get_value('find')
	str_to = dpg.get_value('replace')
	match_count = len([f for f in files if str_from.strip() !='' and str_from in f])
	for i, file in enumerate(files):
		if str_from.strip() != '' and str_from in file:
			src = os.path.join(folder, file)
			dst = os.path.join(folder, file.replace(str_from, str_to))
			os.rename(src, dst)
	rebuild_child_win()
	
	dpg.set_value('status', f'Finished renaming {match_count} files.')

	with open('./.pref', 'w') as f:
		f.write(folder)


def rebuild_child_win():
	folder = dpg.get_value('folder')
	if os.path.isdir(folder):
		files = sorted(os.listdir(folder))
		str_from = dpg.get_value('find')
		str_to = dpg.get_value('replace')
		match_count = len([f for f in files if str_from.strip() !='' and str_from in f])
		dpg.set_value('status', f'{match_count} matches.')
		dpg.delete_item('childwin', children_only=True)
		with dpg.table(tag='tbl', parent='childwin', row_background=True):
			dpg.add_table_column(label='Original name')
			dpg.add_table_column(label='Replaced name')

			for i, file in enumerate(files):
				with dpg.table_row(tag=f'row{i}'):
					icon = 'file' if os.path.isfile(os.path.join(folder, file)) else 'folder'
					tag = f'fname{i}'
					with dpg.table_cell():
						with dpg.group(horizontal=True):
							dpg.add_image(f'icon_{icon}', width=16, height=16)
							dpg.add_text(file, tag=tag)
							
							# add clicked handler
							tag_handler_reg = f'handlerreg{i}'
							tag_handler = f'handler{i}'
							dpg.delete_item(tag_handler)
							dpg.delete_item(tag_handler_reg)
							dpg.add_item_handler_registry(tag=tag_handler_reg)
							dpg.add_item_clicked_handler(parent=tag_handler_reg, tag=tag_handler, callback=table_click, user_data=file)	
							dpg.bind_item_handler_registry(tag, tag_handler_reg)

					with dpg.table_cell():
						with dpg.group(horizontal=True):
							dpg.add_image(f'icon_{icon}', width=16, height=16)	
							dpg.add_text(file.replace(str_from or '', str_to or ''))
				if str_from.strip() != '' and str_from in file:
					dpg.set_table_row_color('tbl', i, (7, 117, 235))

def pick_folder(sender=None, files=[], cancel_pressed=True):
	folder = dpg.get_value('folder')
	if not cancel_pressed:
		if len(files):
			folder = os.path.dirname(files[0])
	dpg.set_value('folder', folder)
	rebuild_child_win()
	

with dpg.window() as mainwin:
	with dpg.group(horizontal=True):
		dpg.add_input_text(tag='folder', callback=rebuild_child_win)

		# dearpygui_extend file browser
		dpge.file_browser(
			default_path=DEFAULT_PATH,
			label=dpge.file_browser.ICON_FOLDER,
			width=800,
			height=600,
			pos=(10,30),
			show_as_window=True,
			show_ok_cancel=True,
			show_hidden_files=True,
			allow_multi_selection=False,
			show_nav_icons=False,
			callback=pick_folder,
		)
		
	with dpg.group(horizontal=True):
		dpg.add_input_text(tag='find', hint='find text', width=200, callback=rebuild_child_win)
		dpg.add_text(' --> ')
		dpg.add_input_text(tag='replace', hint='replace text', width=200, callback=rebuild_child_win)
		dpg.add_button(label='Replace all', width=115, callback=replace)
		dpg.add_text(tag='status')
	
	dpg.add_child_window(tag='childwin')

#init
dpg.set_value('folder', DEFAULT_PATH)
rebuild_child_win()
dpg.focus_item('find')

dpg.setup_dearpygui()
dpg.set_primary_window(mainwin, True)
dpg.show_viewport()
dpg.start_dearpygui()
dpg.destroy_context()